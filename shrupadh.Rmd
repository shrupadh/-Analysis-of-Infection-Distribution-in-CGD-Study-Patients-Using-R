---

output: pdf_document
urlcolor: blue
geometry: left = .8in, right = .8in, top = .8in, bottom = .8in
always_allow_html: yes
---

\begin{center}
Due date: Wednesday, May 10
\end{center}


\newcommand{\red}[1]{\textcolor{red}{#1}}
\newcommand{\blue}[1]{\textcolor{blue}{#1}}
\newcommand{\green}[1]{\textcolor{green}{#1}}
\newcommand{\cyan}[1]{\textcolor{cyan}{#1}}
\newcommand{\magenta}[1]{\textcolor{magenta}{#1}}
\newcommand{\yellow}[1]{\textcolor{yellow}{#1}}

```{R setup, include = FALSE}
library(knitr)
library(vcd)
opts_chunk$set(comment = NA, prompt = TRUE, collapse = TRUE)
hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  lines <- options$output.lines
  if (is.null(lines)) return(hook_output(x, options))
  x <- unlist(strsplit(x, "\n"))
  more <- "..."
  if (length(lines) == 1 & length(x) > lines) x <- c(head(x, lines), more)
  if (length(lines) != 1) x <- c(more, x[lines], more)
  x <- paste(c(x, ""), collapse = "\n")
  hook_output(x, options)
})
    ```

**Submission guidance:**

  - Please submit a `Rmd` file, a `pdf` file generated by R markdown, and a signed cover page (this page).
  - Name your file `LastName5353final.pdf` and `LastName5353final.Rmd`, 
  for example, `Chiou5353final.pdf` and `Chiou5353final.Rmd`.
  - Late submissions will not be graded.

**Instructions**

  - Answer questions completely.
  - You are not allowed to collaborate with classmates and/or people outside of this class (including on-line forum).
  - You can email me for clarifications. 
  - Indicate by number which questions you are answering.
  - Include a random seed if you use random number generators.
  - Start a problem in a new page, e.g., `\newpage`.
  - **\large \red{H}\blue{i}\green{g}\cyan{h}\magenta{l}\yellow{i}\red{g}\blue{h}\green{t}** your final answer.
  - There are **4** questions in this exam, each is worth 4 points for a possible total of 56 points.

**Please sign below to indicate that you have read, understand, and agree with the exam policy:**

I understand that violation of this agreement will result in an **F** on this exam and it cannot be replaced, it will be averaged in (as a 0\%) with my other scores. Violations of this agreement as it relates to the UTD Student Code of Conduct will be turned in to the Dean of Students Office.

\vspace{.7cm}
Student name (print): Shradha Upadhyay  Signature: Shradha

\newpage

In homework 10, we considered the `cgd` dataset from the `survival` package. 
```{R}
data(cgd, package = "survival")
```
The dataset has 203 rows of data and 16 variables (See ?survival::cgd for details). 
Initially, we focused on the variables:

  - `id` subject identification number.
  - `tstart` and `tstop` the start and end of each time interval.
  - `status` equals 1 if the interval ends with an infection.

Other variables of interest in the dataset are:

  - `center` enrolling center
  - `treatment` placebo or gamma interferon
  - `age` age in years, at study entry
  - `sex` sex
  - `enum` observation number within subject

Following homework 10, the number of infections experienced by each patient can be
summarized with `nInf`.
```{R}
table(nInf <- aggregate(status ~ id, cgd, sum)$status)
```

We will use the `cgd` dataset and those variables to answer the following questions.

## Preliminary study:

1. What is the sample size of this dataset? In other words, how many patients participated in this study?
2. Which patient has the most infection episodes?
3. Which enrolling center has the most patients? 
4. What proportion of patients received placebo? 
5. What are the average ages for male and female patients, respectively?
6. What is the average number of days for the first infection?
7. Create a subset of `nInf` that provides the number of infections experienced by each patient
who was enrolled in the NIH center.
Call this vector `nInfNIH` and print `table(nInfNIH)`. \label{nih}

## Data analysis:

8.  Use `nInfNIH` from \#\ref{nih}
and hanging rootograms from the `vcd` package to determine the distribution 
(out of binomial, Poisson, and negative binomial) that fits `nInfNIH` the best.
To receive full credit, display the rootograms, state the hypotheses, $p$-value, and
explain your conclusion. 

9. Let $X$ be the random variable that represents the number of infections experienced by each patient
who was enrolled in the NIH center. \label{goodfit}
Use the best-fit distribution from \#\ref{nih} and its estimated parameter(s) to find the following quantities.

    a. $P(X = 1)$
    b. $P(X > 1)$

\newpage 

10. Use the best-fit distribution from \#\ref{nih} and its estimated parameter(s) to find the following quantities.

    a. $E(X)$
    2. The third quantile (Q3)
    
11. 
Suppose we aim to approximate the probabilities in \#\ref{goodfit} using a normal distribution. 
What would be the appropriate choice of the mean and standard deviation for the normal distribution?

12. What are the normal approximations to the following probabilities from \#\ref{goodfit} without continuity correction?

    a. $P(X = 1)$
    b. $P(X > 1)$

13. What are the normal approximations to the following probabilities from \#\ref{goodfit} with continuity correction?

    a. $P(X = 1)$
    b. $P(X > 1)$

14. Repeat the analysis in \#\ref{nih}, but this time, only consider patients who were 18 years or older at the time of study entry, regardless of the enrolling center. \label{ref}


\newpage
1. What is the sample size of this dataset? In other words, how many patients participated in this study?
```{r}
length(unique(cgd$id))

```

\newpage
2. Which patient has the most infection episodes?
```{r}
library(tidyverse)
cgd %>%
  group_by(id) %>%
  summarise(infections=sum(status)) %>%
  filter(infections==max(infections))
```

\newpage
3. Which enrolling center has the most patients?
```{r}
library(tidyverse)
cgd %>%
  group_by(center) %>%
  summarise(n1_patients = length(unique(id))) %>%
  filter(n1_patients== max(n1_patients))

  
```

\newpage
4. What proportion of patients received placebo?
```{r}
cgd %>%
  group_by(id) %>%
  summarise(placebo=any(treat == "placebo")) %>%
  pull(placebo) %>%
  mean
```

\newpage
5. What are the average ages for male and female patients, respectively?
```{r}
library(dplyr)
cgd %>%
  group_by(id , sex) %>%
  summarise(age= mean(age)) %>%
  ungroup() %>%
  group_by(sex) %>%
  summarise(mean_age = mean(age))
```

\newpage
6. What is the average number of days for the first infection?
```{r}
cgd %>%
  filter(status==1) %>%
  group_by(id) %>%
  filter(tstart == min(tstart)) %>%
  ungroup() %>%
  mutate(days= tstop-tstart) %>%
  summarise(mean(days))
```

\newpage
7. Create a subset of `nInf` that provides the number of infections experienced by each patient
who was enrolled in the NIH center.
Call this vector `nInfNIH` and print `table(nInfNIH)`. \label{nih}
```{r}
table(nInfNIH <- aggregate(status ~ id, cgd, sum, subset=center=="NIH")$status)
```

\newpage

## Data analysis:

8.  Use `nInfNIH` from \#\ref{nih}
and hanging rootograms from the `vcd` package to determine the distribution 
(out of binomial, Poisson, and negative binomial) that fits `nInfNIH` the best.
To receive full credit, display the rootograms, state the hypotheses, $p$-value, and
explain your conclusion. 


H0 : The given data follows a Poisson/Binomial/Negative binomial distribution
HA:The given data does not follows a Poisson/Binomial/Negative binomial distribution
```{r}
library(grid)
library(vcd)
binom_fit  = goodfit(nInfNIH, type="binomial")
summary(binom_fit)
rootogram(binom_fit, shade = TRUE)

pois_fit=goodfit(nInfNIH, type="poisson")
summary(pois_fit)
rootogram(pois_fit, shade = TRUE)

nbinom_fit=goodfit(nInfNIH, type="nbinomial")
summary(nbinom_fit)
rootogram(nbinom_fit, shade = TRUE)
```
Conclusion: The  Poisson model yields the highest p-value(p-value=0.3952) indicating that Poisson distribution fits the data the best. 

\newpage

9. Let $X$ be the random variable that represents the number of infections experienced by each patient
who was enrolled in the NIH center. \label{goodfit}
Use the best-fit distribution from \#\ref{nih} and its estimated parameter(s) to find the following quantities.

    a. $P(X = 1)$
```{r}
dpois(1, pois_fit$par$lambda)
```
    
    b. $P(X > 1)$
```{r}
1 - ppois(1, pois_fit$par$lambda)
```
    

\newpage 

10. Use the best-fit distribution from \#\ref{nih} and its estimated parameter(s) to find the following quantities.

    a. $E(X)$
```{r}
pois_fit$par$lambda
```
    
    2. The third quantile (Q3)
```{r}
qpois(0.75, pois_fit$par$lambda)
```
    

\newpage    
11. 
Suppose we aim to approximate the probabilities in \#\ref{goodfit} using a normal distribution. 
What would be the appropriate choice of the mean and standard deviation for the normal distribution?
```{r}
mean = lambda = 0.6153846
#sd = sqrt(lambda)= 0.7844645
sigma=sqrt(0.6153846)
```

#Sigma= 0.7844645
#mean = lambda = 0.6153846
\newpage
12. What are the normal approximations to the following probabilities from \#\ref{goodfit} without continuity correction?

    a. $P(X = 1)$
```{r}
pnorm(1, pois_fit$par$lambda, sqrt(pois_fit$par$lambda))- pnorm(1, pois_fit$par$lambda, sqrt(pois_fit$par$lambda))

```
    
    b. $P(X > 1)$
```{r}
pnorm(1, pois_fit$par$lambda, sqrt(pois_fit$par$lambda), lower.tail = F)
```
    

\newpage
13. What are the normal approximations to the following probabilities from \#\ref{goodfit} with continuity correction?

    a. $P(X = 1)$
```{r}
pnorm(1.5,pois_fit$par$lambda, sqrt(pois_fit$par$lambda))- pnorm(0.5, pois_fit$par$lambda, sqrt(pois_fit$par$lambda))
```
    
    b. $P(X > 1)$
```{r}
pnorm(1.5,pois_fit$par$lambda, sqrt(pois_fit$par$lambda),lower.tail= F)
```
    
\newpage
14. Repeat the analysis in \#\ref{nih}, but this time, only consider patients who were 18 years or older at the time of study entry, regardless of the enrolling center. \label{ref}
```{r}
table(nInf18 <- aggregate(status ~ id, cgd, sum, subset=age>=18)$status)
```
H0 : The given data follows a Poisson/Binomial/Negative binomial distribution
HA:The given data does not follows a Poisson/Binomial/Negative binomial distribution
```{r}
library(grid)
library(vcd)
binom_fit  = goodfit(nInf18, type="binomial")
rootogram(binom_fit, shade = TRUE)

pois_fit=goodfit(nInf18, type="poisson")
rootogram(pois_fit, shade = TRUE)

nbinom_fit=goodfit(nInf18, type="nbinomial")
rootogram(nbinom_fit, shade = TRUE)
```
Conclusion: The  nbinomial yields the highest p-value(p-value=0.066821) indicating that Poisson distribution fits the data the best. 


